name: Push to branches

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      ENV_NAME: ${{ steps.compute_env.outputs.ENV_NAME }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Compute environment
        id: compute_env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "BASE_URL=frostbreak.org" >> $GITHUB_OUTPUT
            echo "PAGES_PATH=." >> $GITHUB_OUTPUT
          else
            echo "BASE_URL=frostbreak.org/staging" >> $GITHUB_OUTPUT
            echo "PAGES_PATH=staging" >> $GITHUB_OUTPUT
          fi

      - name: CI
        uses: ./.github/actions/ci
        env:
          BASE_URL: ${{ steps.compute_env.outputs.BASE_URL }}
        with:
          pages: true
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: github-pages

      - name: Download Pages artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ${{ needs.build.outputs.PAGES_PATH }}

      - name: Commit environment
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git add ${{ needs.build.outputs.PAGES_PATH }}
          git commit -m "Deploy to GitHub Pages from ${{ github.ref }}"
          git push origin github-pages
